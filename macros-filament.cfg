[gcode_macro LOAD_FILAMENT]
gcode:
    {% set load_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
	M117 Nozzle heating...
	{action_respond_info("Nozzle heating...")}
        {% if printer.extruder.target == 0 %}
            M109 S{load_temp}
        {% else %}
            M109 S{printer.extruder.target}
        {% endif %}
        M117 Extruding...
        G91 
        G1 E75 F300
        G1 E50 F150
        G1 E-2 F300
        G90
        M400
        M117 Extrude Finish
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't load filament during printing!!!")}
    {% endif %}

    
[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set load_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
	M117 Nozzle heating...
	{action_respond_info("Nozzle heating...")}
	{% if printer.extruder.target == 0 %}
            M109 S{load_temp}
        {% else %}
            M109 S{printer.extruder.target}
        {% endif %}
        M117 Retracting...
        G91
        G1 E+25 F300
        G1 E-10 F1500
        G1 E-20 F600
        M400
        G4 P3000
        G1 E-50 F300 
        G90
        M400
        M117 Retract Finish
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't unload filament during printing!!!")}
    {% endif %}

